<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posting & World wide</title>
    <link rel="icon" type="image/png" href="falcons_logo.png">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
   <style>
       body {
    font-family: Arial, sans-serif;
    background-color: #000; /* Set the background to black */
    color: #fff; /* Set text color to white for better contrast */
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.back-btn {
    position: fixed;
    top: 20px;
    left: 20px;
    background: #fff;
    color: #333;
    border: none;
    padding: 12px 16px;
    border-radius: 50%;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.3s;
}
/* Logo Styling */
#logo {
    position: fixed;
    top: 20px;
    left: 150px; /* Adjust the position to fit the layout */
    width: 150px; /* Set the size of the logo */
    height: auto;
    z-index: 1000; /* Ensure it stays on top */
}

.back-btn:hover {
    background: #f0f0f0;
}
.container {
    width: 40%; /* Reduced the width */
    background: #222; /* Dark background for the container */
    color: #fff; /* White text inside the container */
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    margin-top: 20px;
}

h1 {
    text-align: center;
}

#postContainer {
    margin-top: 20px;
}

.post {
    background: #333; /* Darker background for individual posts */
    color: #fff; /* White text inside posts */
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}
.post-header {
    display: flex;
    align-items: center;
    font-size: 14px;
    color: #fff;
    font-weight: bold;
}

.post-header i {
    font-size: 24px;
    margin-right: 10px;
}

.post-text {
    font-size: 16px;
    margin: 10px 0;
}

.post-footer {
    font-size: 12px;
    color: #bbb;
}


/* Floating Create Post Button */
/* Floating Create Post Button */
.create-post-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: linear-gradient(45deg, #ff416c, #ff4b2b);
    border: none;
    font-size: 18px;
    color: white;
    cursor: pointer;
    padding: 15px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease-in-out;
    box-shadow: 0 4px 10px rgba(255, 65, 108, 0.5);
    z-index: 9999; /* Ensure it stays on top */
}

.create-post-btn:hover {
    background: linear-gradient(45deg, #ff512f, #dd2476);
    transform: scale(1.1);
}


/* Post Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: #222; /* Dark background for modal */
    color: #fff; /* White text */
    padding: 20px;
    border-radius: 10px;
    width: 40%;
    box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
    text-align: center;
}


.modal-content textarea {
    width: 100%;
    height: 80px;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
}

.modal-actions {
    margin-top: 10px;
    display: flex;
    justify-content: space-between;
}

.save-btn, .cancel-btn {
    padding: 10px 20px;
    border: none;
    cursor: pointer;
    font-size: 16px;
    color: white;
    border-radius: 5px;
}

.save-btn {
    background: #28a745;
}
#uploadProgressContainer {
    margin-top: 10px;
    padding: 10px;
    background-color: #333; /* Dark background */
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    width: 80%; /* Adjust this to control the width */
    max-width: 500px; /* Max width to avoid excessive stretch */
    display: none;
    margin: 0 auto; /* Center the container */
}

#uploadProgress {
    width: 100%;
    height: 25px;
    border-radius: 5px;
    background-color: #ddd;
    appearance: none;
}

#uploadProgress::-webkit-progress-bar {
    background-color: #f5f5f5;
    border-radius: 5px;
}

#uploadProgress::-webkit-progress-value {
    background-color: #4caf50;
    border-radius: 5px;
}

#uploadProgress::-moz-progress-bar {
    background-color: #4caf50;
    border-radius: 5px;
}

#uploadProgressText {
    display: block;
    text-align: center;
    font-size: 14px;
    margin-top: 5px;
    color: #333;
}

/* Style for the reaction button */
.reaction-btn {
    display: inline-block;
    background-color: #f2f2f2;
    padding: 10px;
    border-radius: 25px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    font-size: 20px;
    border: none;
}

/* Style for the reaction button icon */
.reaction-btn i {
    font-size: 18px;
    color: #333;
}

/* Hover effect on reaction button */
.reaction-btn:hover {
    background-color: #ddd;
}
.reactions-options {
    display: none; /* Ensure it's hidden initially */
    position: absolute;
    bottom: 40px;
    left: 0;
    background: white;
    padding: 10px;
    border-radius: 12px;
    box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
    z-index: 1000;
    flex-wrap: wrap;
    gap: 8px;
}

/* Ad Container */
.ad-container {
    position: fixed; /* Keeps it in place while scrolling */
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    width: 200px; /* Increased from 160px */
    background: white;
    padding: 12px;
    border-radius: 12px;
    box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 1000; /* Ensures it stays above other content */
}

/* Ad Image */
.ad-image {
    width: 180px; /* Increased from 150px */
    height: auto; 
    border-radius: 10px;
}

/* Ad Close Button */
.ad-close-btn {
    position: absolute;
    top: -7px;
    right: -7px;
    background: white;
    color: red;
    border: none;
    font-size: 18px;
    cursor: pointer;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25);
    transition: 0.3s;
}

.ad-close-btn:hover {
    background: #ddd;
}

/* Ad Text */
.ad-text {
    font-size: 16px; /* Increased font size */
    color: gray;
    margin-top: 10px;
}





/* Style for the accounts container items */
.accounts-container h3 {
    text-align: center;
    font-size: 20px;
    margin-bottom: 15px;
}

.accounts-container .account {
    margin-bottom: 10px;
    font-size: 16px;
}
/* Hide all controls initially */
.custom-video-controls, .custom-play-btn {
    display: none;
}

/* Show controls when hovering over video container */
.custom-video-container:hover .custom-video-controls,
.custom-video-container:hover .custom-play-btn {
    display: block !important;
}

/* Remove default web video controls */
video::-webkit-media-controls {
    display: none !important;
}
/* Make search button appear in the top-right */
.search-container {
    position: absolute;
    top: 15px;
    right: 15px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    background: black;
    padding: 5px 10px;
    border-radius: 25px;
    width: 40px;
    overflow: hidden;
    transition: width 0.4s ease-in-out;
    cursor: pointer;
}

.search-container.expanded {
    width: 220px;
}

.search-icon {
    font-size: 18px;
    color: white;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.search-box {
    width: 100%;
    padding: 5px 10px;
    border: none;
    border-radius: 20px;
    outline: none;
    background: #333;
    color: white;
    font-size: 14px;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
}

.search-container.expanded .search-box {
    opacity: 1;
}

.accounts-container {
    width: 24%;
    background: black;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    margin-top: 20px;
    position: absolute;
    top: 20px;
    right: 10px;
    z-index: 999;
    overflow: hidden;
}



.cancel-btn {
    background: #dc3545;
}
   </style>
</head>
<body>
<div id="adContainer" class="ad-container">
    <button class="ad-close-btn" onclick="closeAd()">
        <i class="fas fa-times"></i>
    </button>
    <img src="Toyota.png" alt="Toyota Ad" class="ad-image">
    <p class="ad-text">Ad</p>
</div>
 <div class="accounts-container">
    <div class="search-container">
    <i class="fas fa-search search-icon"></i>
    <input type="text" id="searchInput" class="search-box" placeholder="Search users..." oninput="fetchUsersAndDisplay()">
</div>

<h3>Accounts To Explore</h3>
<div id="accountsContainer"></div>

 </div>
     <div class="container">
        <h3>Posts</h3>
        <div id="postContainer"></div>
    </div>
<!-- Floating Back Button (Independent at Left-Top) -->
<button class="back-btn" onclick="window.location.href='maininterface.html'">
    <i class="fas fa-arrow-left"></i>
</button>
    <!-- Logo Image -->
<img id="logo" src="falcons_logo.png" alt="Logo">

    <!-- Floating Create Post Button -->
    <button class="create-post-btn" onclick="openPostDialog()">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Post Creation Modal -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <h2>Create Post</h2>
            <div id="uploadProgressContainer" style="display: none;">
    <progress id="uploadProgress" value="0" max="100" style="width: 100%;"></progress>
    <span id="uploadProgressText">0%</span>
</div>
            <textarea id="postText" placeholder="What's on your mind?"></textarea>
              <div class="media-upload">
        <input type="file" id="mediaInput" accept="image/*, video/*" style="display: none;" onchange="previewMedia(event)">
        <button onclick="document.getElementById('mediaInput').click()">
            <i class="fas fa-folder"></i> Select Media
        </button>
    </div>
    <div id="mediaPreview" style="margin-top: 10px;"></div>
            <textarea id="descriptionText" style="display: none;" placeholder="Add a description (optional)"></textarea>
            <div class="modal-actions">
                <button class="save-btn" onclick="savePost()"><i class="fas fa-check"></i> Save</button>
                <button class="cancel-btn" onclick="closePostDialog()"><i class="fas fa-times"></i> Cancel</button>
            </div>
        </div>
       

    </div>
 
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBcTEVvxXmv5N8dJav4xNDRy5hXZRjVeM4",
            authDomain: "chatflow-59776.firebaseapp.com",
            databaseURL: "https://chatflow-59776-default-rtdb.firebaseio.com",
            projectId: "chatflow-59776",
            storageBucket: "chatflow-59776.appspot.com",
            messagingSenderId: "549003131640",
            appId: "1:549003131640:web:3f4a7b8cef4c0d8a2b990d",
            measurementId: "G-V2180PR5CR"
        };

        firebase.initializeApp(firebaseConfig);
        const firestore = firebase.firestore();
        const auth = firebase.auth();
        const postContainer = document.getElementById('postContainer');

        function fetchAndDisplayName(email, callback) {
        const namesRef = firestore.collection("names");
        namesRef.where("email", "==", email).get().then((snapshot) => {
            let lastTimestamp = 0;
            let latestName = "Unknown User"; // Default name

            snapshot.forEach((doc) => {
                const timestamp = doc.get("timestamp") || 0;
                const name = doc.get("name");

                if (timestamp > lastTimestamp && name) {
                    lastTimestamp = timestamp;
                    latestName = name;
                }
            });

            callback(latestName);
        }).catch(error => {
            console.error("Error fetching name:", error);
            callback("Unknown User");
        });
    }
document.addEventListener("DOMContentLoaded", () => {
    const searchContainer = document.querySelector(".search-container");
    const searchInput = document.getElementById("searchInput");
    const searchIcon = document.querySelector(".search-icon");

    // Expand search bar when clicking the icon
    searchIcon.addEventListener("click", () => {
        searchContainer.classList.toggle("expanded");
        if (searchContainer.classList.contains("expanded")) {
            searchInput.focus();
        } else {
            searchInput.value = ""; // Clear search when closed
            fetchUsersAndDisplay(); // Reset list
        }
    });

    // Close search when clicking outside
    document.addEventListener("click", (event) => {
        if (!searchContainer.contains(event.target)) {
            searchContainer.classList.remove("expanded");
            searchInput.value = "";
            fetchUsersAndDisplay(); // Reset list
        }
    });

    fetchUsersAndDisplay(); // Load all users initially
});

function fetchUsersAndDisplay() {
    const searchQuery = document.getElementById("searchInput").value.toLowerCase();
    const namesRef = firestore.collection("names");
    const usersRef = firestore.collection("users");
    const accountsContainer = document.getElementById("accountsContainer");
    accountsContainer.innerHTML = ""; // Clear the accounts container

    const currentUserEmail = firebase.auth().currentUser.email;

    // If search is empty, display all users
    if (!searchQuery) {
        usersRef.get().then(displayUsersFromSnapshot);
        return;
    }

    let matchedEmails = {}; // Use an object instead of Set

    // Step 1: Get all emails associated with the searched name
    namesRef.get().then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
            const name = doc.data().name || "Unknown User";
            const email = doc.data().email;

            // If name matches search, add the corresponding email
            if (name.toLowerCase().includes(searchQuery)) {
                matchedEmails[email] = true; // Store as key-value pair to avoid duplicates
            }
        });

        if (Object.keys(matchedEmails).length === 0) {
            accountsContainer.innerHTML = "<p style='color: white;'>No matching users found</p>";
            return;
        }

        // Step 2: Get users from the "users" collection who match those emails
        usersRef.get().then((querySnapshot) => {
            const filteredUsers = [];
            querySnapshot.docs.forEach((doc) => {
                const userEmail = doc.data().email;
                if (matchedEmails[userEmail]) {
                    filteredUsers.push(doc);
                    delete matchedEmails[userEmail]; // Ensure uniqueness
                }
            });

            if (filteredUsers.length === 0) {
                accountsContainer.innerHTML = "<p style='color: white;'>No matching users found</p>";
            } else {
                displayUsersFromSnapshot(filteredUsers);
            }
        });
    });
}

// Function to display users from a snapshot (filtered list)
function displayUsersFromSnapshot(usersArray) {
    const accountsContainer = document.getElementById("accountsContainer");
    const currentUserEmail = firebase.auth().currentUser.email;

    let displayedUsers = {}; // Use object instead of Set

    usersArray.forEach((doc) => {
        const userEmail = doc.data().email;

        // Skip if user is already displayed or is the current user
        if (!userEmail || userEmail === currentUserEmail || displayedUsers[userEmail]) return;

        displayedUsers[userEmail] = true; // Mark user as displayed

        const userDiv = document.createElement("div");
        userDiv.classList.add("user-item");

        // Create profile image element
        const profileImg = document.createElement("img");
        profileImg.classList.add("profile-photo");
        profileImg.addEventListener("click", () => {
            window.location.href = `profile_of_user?userEmail=${encodeURIComponent(userEmail)}`;
        });

        // Create name container
        const nameContainer = document.createElement("div");
        nameContainer.classList.add("name-container");

        // Create name element
        const nameSpan = document.createElement("span");
        nameSpan.classList.add("user-name");

        // Create verification icon
        const verificationImg = document.createElement("img");
        verificationImg.src = "verification.png";
        verificationImg.classList.add("verification-icon");
        verificationImg.style.display = "none"; // Hidden by default

        // Append name and verification icon to nameContainer
        nameContainer.appendChild(nameSpan);
        nameContainer.appendChild(verificationImg);

        // Create follow button
        const followButton = document.createElement("button");
        followButton.classList.add("follow-btn");
        followButton.innerHTML = `<span class="plus-icon">+</span> Follow`;

        // Hide follow button if the user is viewing their own profile
        if (userEmail === currentUserEmail) {
            followButton.style.display = "none";
        } else {
            followButton.addEventListener("click", () => {
                followUser(currentUserEmail, userEmail, followButton);
            });

            // Check if already followed
            checkFollowedOrNot(currentUserEmail, userEmail, followButton);
        }

        // Create user info container
        const userInfoContainer = document.createElement("div");
        userInfoContainer.classList.add("user-info-container");
        userInfoContainer.appendChild(nameContainer);
        userInfoContainer.appendChild(followButton);

        // Append elements to the userDiv
        userDiv.appendChild(profileImg);
        userDiv.appendChild(userInfoContainer);

        // Append userDiv to accountsContainer
        accountsContainer.appendChild(userDiv);

        // Fetch profile photo
        fetchProfilePhotoForAccount(userEmail, (photoUrl) => {
            profileImg.src = photoUrl;
        });

        // Fetch and display name
        fetchAndDisplayName(userEmail, (userName) => {
            nameSpan.textContent = userName;
        });

        // Check verification status
        checkVerifiedOrNotForAccount(userEmail, (isVerified) => {
            if (isVerified) {
                verificationImg.style.display = "inline-block";
            }
        });
    });


    // Add CSS Styles
    const style = document.createElement("style");
    style.textContent = `
        .user-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }
        .profile-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
        }
        .name-container {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .user-name {
            font-size: 16px;
            font-weight: bold;
            color: white;
            margin-right: 6px;
        }
        .verification-icon {
            width: 18px;
            height: 18px;
        }
        .user-info-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            width: 150px;
        }
        .follow-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, #007bff, #00c6ff);
            color: white;
            border: none;
            padding: 6px 14px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            box-shadow: 0px 4px 6px rgba(0, 123, 255, 0.3);
            outline: none;
            width: 100px;
        }
        .follow-btn:hover {
            background: linear-gradient(45deg, #0056b3, #0086ff);
            transform: scale(1.05);
        }
        .plus-icon {
            font-size: 18px;
            font-weight: bold;
            margin-right: 6px;
        }
    `;
    document.head.appendChild(style);
}

function closeAd() {
    const ad = document.getElementById("adContainer");
    ad.style.display = "none";

    // Reappear after 10 seconds
    setTimeout(() => {
        ad.style.display = "flex";
    }, 10000);
}
        

function fetchAndDisplayName(email, callback) {
    const namesRef = firestore.collection("names");
    namesRef.where("email", "==", email).get().then((snapshot) => {
        let lastTimestamp = 0;
        let latestName = "Unknown User";

        snapshot.forEach((doc) => {
            const timestamp = doc.data().timestamp || 0;
            const name = doc.data().name;

            if (timestamp > lastTimestamp && name) {
                lastTimestamp = timestamp;
                latestName = name;
            }
        });

        callback(latestName);
    }).catch(error => {
        console.error("Error fetching name:", error);
        callback("Unknown User");
    });
}
function followUser(currentUserEmail, targetUserEmail, followButton) {
    const agesRef = firestore.collection("ages");

    // Find the document where email == targetUserEmail
    agesRef.where("email", "==", targetUserEmail).get().then((querySnapshot) => {
        if (querySnapshot.empty) {
            console.error("User not found in ages collection.");
            return;
        }

        querySnapshot.forEach((doc) => {
            const userDocRef = agesRef.doc(doc.id);
            const followersRef = userDocRef.collection("followers");

            // Check if already followed
            followersRef.where("follower", "==", currentUserEmail).get().then((snapshot) => {
                if (!snapshot.empty) {
                    // Unfollow: Remove the follower document
                    snapshot.forEach((followerDoc) => {
                        followersRef.doc(followerDoc.id).delete().then(() => {
                            console.log("Unfollowed successfully");
                            updateFollowButton(followButton, false);
                        }).catch((error) => console.error("Error unfollowing:", error));
                    });
                } else {
                    // Follow: Add new follower
                    followersRef.add({
                        follower: currentUserEmail,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => {
                        console.log("Followed successfully");
                        updateFollowButton(followButton, true);
                    }).catch((error) => console.error("Error following:", error));
                }
            });
        });
    }).catch((error) => console.error("Error fetching ages collection:", error));
}
function checkFollowedOrNot(currentUserEmail, targetUserEmail, followButton) {
    const agesRef = firestore.collection("ages");

    // Find the document where email == targetUserEmail
    agesRef.where("email", "==", targetUserEmail).get().then((querySnapshot) => {
        if (querySnapshot.empty) {
            console.error("User not found in ages collection.");
            return;
        }

        querySnapshot.forEach((doc) => {
            const followersRef = agesRef.doc(doc.id).collection("followers");

            // Check if the current user is a follower
            followersRef.where("follower", "==", currentUserEmail).get().then((snapshot) => {
                updateFollowButton(followButton, !snapshot.empty);
            }).catch((error) => console.error("Error checking follow status:", error));
        });
    }).catch((error) => console.error("Error fetching ages collection:", error));
}
function updateFollowButton(followButton, isFollowed) {
    if (isFollowed) {
        followButton.innerHTML = `<span class="check-icon" style="font-weight: bold;">✔</span> Followed`;
        followButton.style.background = "linear-gradient(45deg, #28a745, #85e085)"; // Green gradient
        followButton.style.color = "white";
        followButton.style.border = "none";
        followButton.style.boxShadow = "0px 4px 6px rgba(0, 0, 0, 0.2)";
    } else {
        followButton.innerHTML = `<span class="plus-icon">+</span> Follow`;
        followButton.style.background = "linear-gradient(45deg, #007bff, #00c6ff)";
    }
}

function fetchProfilePhotoForAccount(userEmail, callback) {
    const profilesPhotoRef = firestore.collection("profilesphoto");

    profilesPhotoRef
        .where("uploaderEmail", "==", userEmail)
        .get()
        .then((querySnapshot) => {
            let latestPhotoUrl = "profile.png"; // Default profile photo
            let latestTimestamp = 0;

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const timestamp = data.timestamp || 0;
                const photoUrl = data.downloadUrl;

                if (timestamp > latestTimestamp) {
                    latestTimestamp = timestamp;
                    latestPhotoUrl = photoUrl;
                }
            });

            callback(latestPhotoUrl);
        })
        .catch((error) => {
            console.error("Error fetching profile photo:", error);
            callback("user_1077114.png"); // Default profile photo on error
        });
}


function checkVerifiedOrNotForAccount(userEmail, callback) {
    const verificationRef = firestore.collection("verificationbridge");
    verificationRef.where("email", "==", userEmail).get().then((snapshot) => {
        callback(!snapshot.empty);
    }).catch(error => {
        console.error("Error checking verification:", error);
        callback(false);
    });
}

    function fetchProfilePhoto(userEmail, callback) {
        const profilesPhotoRef = firestore.collection("profilesphoto");
        profilesPhotoRef.where("uploaderEmail", "==", userEmail)
            .get()
            .then((querySnapshot) => {
                let latestPhotoUrl = "user_1077114.png"; // Default profile photo
                let latestTimestamp = 0;

                querySnapshot.forEach((doc) => {
                    const timestamp = doc.data().timestamp || 0;
                    const photoUrl = doc.data().downloadUrl;

                    if (timestamp > latestTimestamp) {
                        latestTimestamp = timestamp;
                        latestPhotoUrl = photoUrl;
                    }
                });

                callback(latestPhotoUrl);
            })
            .catch((error) => {
                console.error("Error fetching profile photo:", error);
                callback("user_1077114.png"); // Fallback to default
            });
    }
function previewMedia(event) {
    const file = event.target.files[0];
    const previewContainer = document.getElementById('mediaPreview');
    const textArea = document.getElementById('postText');
    const descriptionText = document.getElementById('descriptionText'); // Get the description textarea
    previewContainer.innerHTML = ""; // Clear previous preview

    // Initially, hide the description field
    descriptionText.style.display = 'none';

    if (file) {
        const fileType = file.type.split('/')[0]; // 'image' or 'video'
        const url = URL.createObjectURL(file);

        if (fileType === 'image') {
            previewContainer.innerHTML = `<img src="${url}" style="max-width: 100%; max-height: 200px; border-radius: 5px;">`;
        } else if (fileType === 'video') {
            previewContainer.innerHTML = `<video src="${url}" controls style="max-width: 100%; max-height: 200px;"></video>`;
        }

        // Hide postText area and show description textarea
        textArea.style.display = 'none';
        descriptionText.style.display = 'block';
    } else {
        // Show postText area and hide description textarea if no file is selected
        textArea.style.display = 'block';
        descriptionText.style.display = 'none';
    }
}


function reactToPost(postId, reactionType, btn) {
    const userEmail = firebase.auth().currentUser.email;
    const reactionsCollection = firestore.collection("postforall").doc(postId).collection("falconspostreaction");

    reactionsCollection.where("reactor", "==", userEmail).get().then(snapshot => {
        let hasReacted = false;
        let oldReactionType = null;

        if (!snapshot.empty) {
            snapshot.forEach(doc => {
                hasReacted = true;
                oldReactionType = doc.data().reactionType;
                doc.ref.delete(); // Remove old reaction
            });
        }

        if (!hasReacted || oldReactionType !== reactionType) {
            // Add new reaction
            reactionsCollection.add({
                reactor: userEmail,
                reactionType: reactionType,
                timestamp: Date.now()
            }).then(() => {
                updateReactionIcon(postId, reactionType);
                
            }).catch(error => console.error("Error saving reaction:", error));
        } else {
            // If the same reaction is clicked, remove it
            updateReactionIcon(postId, "default");
            
        }
    });

}


// Function to update reaction icon on reaction button
function updateReactionIcon(postId, reactionType) {
    const postElement = document.querySelector(`#post-${postId}`);
    if (!postElement) return;

    const reactionBtn = postElement.querySelector(".reaction-btn");
    
    let emoji = "";
    switch (reactionType) {
        case 'love': emoji = '❤️'; break;
        case 'like': emoji = '👍'; break;
        case 'haha': emoji = '😂'; break;
        case 'angry': emoji = '😡'; break;
        default: emoji = '<i class="fa fa-heart"></i>'; // Default icon
    }
    
    reactionBtn.innerHTML = emoji;
}

// Function to check user's reaction on a post
function checkUserReaction(postId) {
    const userEmail = firebase.auth().currentUser.email;
    const reactionsCollection = firestore.collection("postforall").doc(postId).collection("falconspostreaction");

    reactionsCollection.where("reactor", "==", userEmail).get().then(snapshot => {
        if (!snapshot.empty) {
            snapshot.forEach(doc => {
                updateReactionIcon(postId, doc.data().reactionType);
            });
        }
    });
}





function isVideoUrl(text) {
    return text.startsWith("https://firebasestorage.googleapis.com") &&
           text.includes("/socialpostvideooffalcons%2F");
}

function isImageUrl(text) {
    return text.startsWith("https://firebasestorage.googleapis.com") &&
           text.includes("/socialpostimageoffalcons%2F");
}
function fetchPosts() {
    firestore.collection("postforall").orderBy("timestamp", "desc").onSnapshot(snapshot => {
        postContainer.innerHTML = "";
        snapshot.forEach(doc => {
            let post = doc.data();
            let postId = doc.id;
            let postElement = document.createElement("div");
            postElement.classList.add("post");
            postElement.id = "post-" + postId;

            fetchAndDisplayName(post.poster, (displayName) => {
                fetchProfilePhoto(post.poster, (profilePhotoUrl) => {
                    checkVerifiedOrNot(post.poster, (isVerified) => {
                        firebase.auth().onAuthStateChanged(user => {
                            if (!user) return;
                            const currentUserEmail = user.email;

                            let menuDotHTML = ""; 
                            if (currentUserEmail === post.poster) {
                                menuDotHTML = `
                                    <button class="menu-dot" onclick="showPostMenu(event, '${postId}')" 
                                        style="background: none; 
                                        border: none; 
                                        font-size: 20px; 
                                        cursor: pointer; 
                                        color: #555; 
                                        padding: 5px; 
                                        position: relative; 
                                        margin-left: 15px;
                                        outline: none;">
                                    &#x22EE;
                                    </button>
                                `;
                            }

                            let mediaContent = "";
                            let descriptionContent = "";

                            let reactionsContent = `
                                <div style="display: flex; align-items: center; position: relative;">
                                    <button class="reaction-btn">
                                        <i class="fa fa-heart"></i> 
                                    </button>
                                    <span class="reaction-summary" id="reaction-summary-${postId}" style="margin-left: 10px; font-size: 14px;"></span>

                                    <div class="reactions-options" style="display: none; 
                                        position: absolute; 
                                        bottom: 40px; 
                                        left: 0; 
                                        background: white; 
                                        padding: 10px; 
                                        border-radius: 12px; 
                                        box-shadow: 0px 4px 10px rgba(0,0,0,0.1); 
                                        z-index: 1000;
                                        display: flex; 
                                        gap: 8px;">
                                        <button class="reaction-option" onclick="reactToPost('${postId}', 'love', this)" style="background: #ffccd5; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 18px; cursor: pointer;">❤️</button>
                                        <button class="reaction-option" onclick="reactToPost('${postId}', 'like', this)" style="background: #cce5ff; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 18px; cursor: pointer;">👍</button>
                                        <button class="reaction-option" onclick="reactToPost('${postId}', 'haha', this)" style="background: #fff3cd; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 18px; cursor: pointer;">😂</button>
                                        <button class="reaction-option" onclick="reactToPost('${postId}', 'angry', this)" style="background: #f8d7da; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 18px; cursor: pointer;">😡</button>
                                    </div>
                                </div>
                            `;

                            if (isImageUrl(post.posttext)) {
    mediaContent = `<img src="${post.posttext}" style="max-width: 100%; max-height: 400px; border-radius: 5px; display: block; margin: 0 auto;">`;
} else if (isVideoUrl(post.posttext)) {
                               mediaContent = 
        `<div class="custom-video-container" style="position: relative; width: 100%; max-height: 400px; border-radius: 5px; overflow: hidden; background-color: black;">
            <video id="video-${postId}" class="custom-video" style="width: 100%; height: auto; display: block;" ontimeupdate="updateVideoTime('${postId}')">
                <source src="${post.posttext}" type="video/mp4">
                Your browser does not support the video tag.
            </video>

            <button class="custom-play-btn" onclick="togglePlay('${postId}')"
    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
    background: rgba(0, 0, 0, 0.6); border: none; color: white; font-size: 24px; 
    cursor: pointer; border-radius: 50%; padding: 10px;">
    <i class="fas fa-play"></i> <!-- FontAwesome Icon Inside -->
</button>


            <!-- Video Controls at Bottom -->
            <div class="custom-video-controls" style="position: absolute; bottom: 10px; left: 10px; right: 10px; 
                display: flex; justify-content: space-between; align-items: center; color: white; 
                padding: 5px 10px; background: rgba(0, 0, 0, 0.6); border-radius: 10px;">
                
                <span class="current-time" id="current-time-${postId}" style="font-size: 14px;">0:00</span>
                
                <input type="range" class="custom-seekbar" id="seekbar-${postId}" value="0" max="100" 
                    onclick="seekVideo('${postId}', this.value)"
                    style="flex-grow: 1; margin: 0 10px; -webkit-appearance: none; background: rgba(255, 255, 255, 0.3);
                    height: 5px; border-radius: 5px; outline: none; cursor: pointer;">
                
                <span class="duration" id="duration-${postId}" style="font-size: 14px;">0:00</span>
            </div>
        </div>`;
                            } else {
                                mediaContent = `<div class="post-text" style="color: white;">${post.posttext}</div>`;
                            }


                            if (post.description) {
                                descriptionContent = `
                                    <div class="post-description" style="max-height: 3.2em; overflow: hidden; color: white;">
                                        ${post.description.length > 100 ? post.description.substring(0, 100) + '...' : post.description}
                                    </div>
                                    ${post.description.length > 100 ? '<button class="see-more-btn" onclick="toggleDescription(this)" style="color: white;">See more</button>' : ''}
                                `;
                            }

                            postElement.innerHTML = `
                                <div class="post-header" style="display: flex; align-items: center; justify-content: space-between;">
                                    <div style="display: flex; align-items: center;">
                                        <img src="${profilePhotoUrl}" alt="Profile Photo" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px;">
                                        <span style="color: white;">${displayName}</span>
                                        <img src="verification.png" alt="Verified" class="verified-icon" style="width: 16px; height: 16px; margin-left: 5px; display: ${isVerified ? 'inline' : 'none'};">
                                    </div>
                                    ${menuDotHTML}
                                </div>
                                ${mediaContent}
                                ${descriptionContent}
                                <div class="post-footer" style="color: white;">${new Date(post.timestamp).toLocaleString()}</div>
                                ${reactionsContent}
                            `;

                            postContainer.appendChild(postElement);

                            checkUserReaction(postId);
                            fetchReactionsCount(postId);

                            let reactionBtn = postElement.querySelector(".reaction-btn");
                            let reactionOptions = postElement.querySelector(".reactions-options");
                            reactionOptions.style.display = "none"; 
                            reactionBtn.addEventListener("mouseenter", () => {
                                reactionOptions.style.display = "flex"; 
                            });

                            postElement.addEventListener("mouseleave", () => {
                                reactionOptions.style.display = "none"; 
                            });
                        });
                    });
                });
            });
        });
    });
}


let videoTimeouts = {}; // Track timeouts for each video

// Function to toggle play/pause
function togglePlay(postId) {
    let video = document.getElementById("video-" + postId);
    let playButton = document.querySelector(`#video-${postId} + .custom-play-btn i`);

    if (video.paused) {
        video.play();
        playButton.classList.remove("fa-play");
        playButton.classList.add("fa-pause");
        hideControls(postId);
    } else {
        video.pause();
        playButton.classList.remove("fa-pause");
        playButton.classList.add("fa-play");
        showControls(postId);
    }
}

function hideControls(postId) {
    videoTimeouts[postId] = setTimeout(() => {
        let controlsContainer = document.querySelector(`#controls-${postId}`);
        let playButton = document.querySelector(`#video-${postId} + .custom-play-btn`);

        if (!document.getElementById(`video-${postId}`).paused) {
            controlsContainer.style.display = "none";
            playButton.style.display = "none";
        }
    }, 3000); // Hide controls after 3 seconds
}

function showControls(postId) {
    let controlsContainer = document.querySelector(`#controls-${postId}`);
    let playButton = document.querySelector(`#video-${postId} + .custom-play-btn`);

    controlsContainer.style.display = "block";
    playButton.style.display = "block";

    clearTimeout(videoTimeouts[postId]); // Clear any existing timeout
}

// Function to update play/pause icon and seekbar
function updateVideoTime(postId) {
    let video = document.getElementById("video-" + postId);
    let currentTime = video.currentTime;
    let duration = video.duration;

    document.getElementById("current-time-" + postId).textContent = formatTime(currentTime);
    document.getElementById("duration-" + postId).textContent = formatTime(duration);

    let seekbar = document.getElementById("seekbar-" + postId);
    if (duration > 0) {
        seekbar.value = (currentTime / duration) * 100;
    }
}

// Function to seek video
function seekVideo(postId, value) {
    let video = document.getElementById("video-" + postId);
    let duration = video.duration;
    video.currentTime = (value / 100) * duration;
}

// Helper function to format time as mm:ss
function formatTime(seconds) {
    let minutes = Math.floor(seconds / 60);
    let remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
}

// Attach event listeners for video controls
document.querySelectorAll('.custom-video-container').forEach(container => {
    let video = container.querySelector('.custom-video');
    let postId = video.id.split('-')[1];

    // Remove default video controls
    video.removeAttribute("controls");

    // Disable PiP and Enhance button
    video.setAttribute("controlsList", "nodownload nofullscreen noremoteplayback");

    // Update time & seekbar when playing
    video.addEventListener('timeupdate', () => updateVideoTime(postId));

    // Show controls on hover
    container.addEventListener('mouseenter', () => showControls(postId));
    container.addEventListener('mouseleave', () => hideControls(postId));

    // Toggle controls when clicking video
    video.addEventListener('click', () => {
        let controlsContainer = document.querySelector(`#controls-${postId}`);
        controlsContainer.style.display = (controlsContainer.style.display === "none") ? "block" : "none";
    });

    // Play/Pause Button Update
    video.addEventListener('play', () => {
        let playButton = document.querySelector(`#video-${postId} + .custom-play-btn i`);
        playButton.classList.remove("fa-play");
        playButton.classList.add("fa-pause");
        hideControls(postId);
    });

    video.addEventListener('pause', () => {
        let playButton = document.querySelector(`#video-${postId} + .custom-play-btn i`);
        playButton.classList.remove("fa-pause");
        playButton.classList.add("fa-play");
        showControls(postId);
    });
});


// Function to show the post menu
function showPostMenu(event, postId) {
    event.stopPropagation();

    // Remove any existing menu
    let existingMenu = document.getElementById("postMenu");
    if (existingMenu) existingMenu.remove();

    // Create menu
    let menu = document.createElement("div");
    menu.id = "postMenu";
    menu.style.position = "fixed"; 
    menu.style.top = `${event.clientY}px`;
    menu.style.left = `${event.clientX}px`;
    menu.style.background = "#fff";
    menu.style.padding = "10px";
    menu.style.borderRadius = "8px";
    menu.style.boxShadow = "0px 4px 10px rgba(0, 0, 0, 0.2)";
    menu.style.zIndex = "9999"; 
    menu.style.minWidth = "120px";
    menu.style.display = "flex";
    menu.style.flexDirection = "column";
    menu.style.alignItems = "center";

    // Menu option
    menu.innerHTML = `
        <button onclick="showDeleteDialog('${postId}')"
            style="display: flex; align-items: center; justify-content: center; width: 100%; padding: 8px; border: none; background: none; font-size: 14px; cursor: pointer; color: red; font-weight: bold;">
            <i class="fa fa-trash" style="margin-right: 8px;"></i> Delete
        </button>
    `;

    document.body.appendChild(menu);

    // Adjust menu position to prevent overflow outside viewport
    let menuRect = menu.getBoundingClientRect();
    let viewportWidth = window.innerWidth;
    let viewportHeight = window.innerHeight;

    if (menuRect.right > viewportWidth) {
        menu.style.left = `${viewportWidth - menuRect.width - 10}px`;
    }
    if (menuRect.bottom > viewportHeight) {
        menu.style.top = `${viewportHeight - menuRect.height - 10}px`;
    }

    // Close menu when clicking outside
    document.addEventListener("click", function closeMenu(event) {
        if (!menu.contains(event.target)) {
            menu.remove();
            document.removeEventListener("click", closeMenu);
        }
    });
}

// Function to show custom delete confirmation dialog
function showDeleteDialog(postId) {
    // Remove any existing dialog
    let existingDialog = document.getElementById("deleteDialog");
    if (existingDialog) existingDialog.remove();

    // Create the dialog container
    let dialog = document.createElement("div");
    dialog.id = "deleteDialog";
    dialog.style.position = "fixed";
    dialog.style.top = "50%";
    dialog.style.left = "50%";
    dialog.style.transform = "translate(-50%, -50%)";
    dialog.style.background = "#fff";
    dialog.style.padding = "20px";
    dialog.style.borderRadius = "10px";
    dialog.style.boxShadow = "0px 5px 15px rgba(0, 0, 0, 0.3)";
    dialog.style.zIndex = "10000";
    dialog.style.textAlign = "center";
    dialog.style.width = "300px";

    // Dialog content
    dialog.innerHTML = `
        <h3 style="margin-bottom: 10px; font-size: 18px;">Confirm Delete</h3>
        <p style="color: #666;">Are you sure you want to delete this post?</p>
        <div style="margin-top: 15px;">
            <button onclick="deletePost('${postId}')"
                style="background: red; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer;">
                Delete
            </button>
            <button onclick="closeDeleteDialog()"
                style="margin-left: 10px; background: gray; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer;">
                Cancel
            </button>
        </div>
    `;

    document.body.appendChild(dialog);
}

// Function to close the delete confirmation dialog
function closeDeleteDialog() {
    let dialog = document.getElementById("deleteDialog");
    if (dialog) dialog.remove();
}

// Function to delete the post
function deletePost(postId) {
    firestore.collection("postforall").doc(postId).delete()
        .then(() => {
            showToast("Post deleted successfully!", "success");
            document.getElementById("post-" + postId)?.remove(); // Remove post from UI
        })
        .catch(error => {
            console.error("Error deleting post: ", error);
            showToast("Failed to delete post. Try again!", "error");
        })
        .finally(() => {
            closeDeleteDialog();
        });
}

// Function to show toast messages
function showToast(message, type) {
    let toast = document.createElement("div");
    toast.className = `toast ${type}`;
    toast.innerText = message;

    // Toast styles
    toast.style.position = "fixed";
    toast.style.bottom = "20px";
    toast.style.left = "50%";
    toast.style.transform = "translateX(-50%)";
    toast.style.padding = "10px 20px";
    toast.style.borderRadius = "5px";
    toast.style.color = "#fff";
    toast.style.fontSize = "14px";
    toast.style.zIndex = "9999";
    toast.style.boxShadow = "0px 4px 10px rgba(0, 0, 0, 0.2)";
    toast.style.transition = "opacity 0.3s ease-in-out";
    toast.style.opacity = "1";

    // Different styles for success and error
    if (type === "success") {
        toast.style.background = "green";
    } else if (type === "error") {
        toast.style.background = "red";
    }

    document.body.appendChild(toast);

    // Auto-remove toast after 3 seconds
    setTimeout(() => {
        toast.style.opacity = "0";
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Function to fetch real-time reaction count updates
function fetchReactionsCount(postId) {
    const reactionsCollection = firestore.collection("postforall").doc(postId).collection("falconspostreaction");

    reactionsCollection.onSnapshot(snapshot => { // Use onSnapshot for real-time updates
        let reactionCounts = {};

        snapshot.forEach(doc => {
            let reactionType = doc.data().reactionType;
            if (!reactionCounts[reactionType]) {
                reactionCounts[reactionType] = 0;
            }
            reactionCounts[reactionType]++;
        });

        // Sort reactions from highest to lowest count
        let sortedReactions = Object.entries(reactionCounts)
            .sort((a, b) => b[1] - a[1]) // Sort by count descending
            .map(([reaction, count]) => `${count} ${reaction}`); // Format text

        let reactionSummary = sortedReactions.length > 0 ? `There are ${sortedReactions.join(', ')}` : '';

        // Update the UI
        let reactionSummaryElement = document.getElementById(`reaction-summary-${postId}`);
        if (reactionSummaryElement) {
            reactionSummaryElement.innerText = reactionSummary;
        }
    });
}

function toggleDescription(button) {
    const descriptionDiv = button.previousElementSibling; // Get the description div
    const isExpanded = descriptionDiv.style.maxHeight === 'none';

    if (isExpanded) {
        descriptionDiv.style.maxHeight = '3.2em'; // Collapse to 2 lines
        button.textContent = 'See more';
    } else {
        descriptionDiv.style.maxHeight = 'none'; // Expand text
        button.textContent = 'See less';
    }
}

function checkVerifiedOrNot(userEmail, callback) {
    const verificationRef = firestore.collection("verificationbridge");

    verificationRef.where("email", "==", userEmail)
        .get()
        .then((snapshot) => {
            callback(!snapshot.empty); // Returns true if verified, false otherwise
        })
        .catch((error) => {
            console.error("Error checking verification status:", error);
            callback(false);
        });
}



        function openPostDialog() {
            document.getElementById('postModal').style.display = 'flex';
        }

        function closePostDialog() {
            document.getElementById('postModal').style.display = 'none';
            document.getElementById('postText').value = '';
        }

 function savePost() {
    const user = firebase.auth().currentUser;
    if (!user) return alert("Please log in to post.");

    const postText = document.getElementById('postText').value.trim();
    const mediaFile = document.getElementById('mediaInput').files[0];
    const descriptionText = document.getElementById('descriptionText').value.trim(); // Get the description text

    if (!postText && !mediaFile && !descriptionText) {
        alert("Post cannot be empty!");
        return;
    }

    let postContent = postText; // Default content is the post text

    if (mediaFile) {
        const fileType = mediaFile.type.split('/')[0]; // Check if it's an 'image' or 'video'
        let folderName = fileType === 'video' ? "socialpostvideooffalcons" : "socialpostimageoffalcons";

        // Show progress bar and set initial value
        document.getElementById('uploadProgressContainer').style.display = 'block';
        const progressBar = document.getElementById('uploadProgress');
        const progressText = document.getElementById('uploadProgressText');
        progressBar.value = 0;
        progressText.textContent = "0%";

        const storageRef = firebase.storage().ref(`${folderName}/${Date.now()}_${mediaFile.name}`);
        const uploadTask = storageRef.put(mediaFile);

        // Monitor upload progress
        uploadTask.on('state_changed', (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            progressBar.value = progress;
            progressText.textContent = `${Math.round(progress)}%`;
        }, (error) => {
            console.error("Error uploading file:", error);
        }, () => {
            uploadTask.snapshot.ref.getDownloadURL().then(mediaUrl => {
                postContent = mediaUrl; // Use media URL as the post text
                savePostToDatabase(user.email, postContent, descriptionText); // Save media URL and description
            }).catch(error => console.error("Error getting media URL:", error));
        });
    } else {
        savePostToDatabase(user.email, postContent, descriptionText); // Save text and description
    }
}


function savePostToDatabase(email, postContent, description) {
    // Create the post data object
    let postData = {
        poster: email,
        posttext: postContent,
        timestamp: Date.now()
    };

    // Only add the description field if it's not null or empty
    if (description && description.trim() !== "") {
        postData.description = description;
    }

    // Save the post to Firestore
    firestore.collection("postforall").add(postData)
        .then(() => {
            closePostDialog();
        })
        .catch(error => console.error("Error saving post:", error));
}



        auth.onAuthStateChanged(user => {
            if (user) {
                fetchPosts();
                fetchUsersAndDisplay()
            } else {
                alert("You must be logged in to view posts.");
            }
        });
    </script>

</body>
</html>
